---
id: "2026-01-31-添加会话最后一条消息字段支持"
title: "添加会话最后一条消息字段支持"
status: "todo"
created: "2026-01-31"
updated: "2026-01-31"
category: "ui"
tags: ["backend", "frontend", "enhancement", "session-list"]
---

# Issue: 添加会话最后一条消息字段支持

## Goal

在会话列表中显示每个会话的最后一条消息内容，让用户可以快速了解会话的最新状态。

## 背景/问题

用户反馈会话列表项"没法看最后一次聊天"，当前实现只显示：
- 会话名称或第一条消息（first_message）
- 目录路径
- 修改时间
- 消息数量

缺少最关键的信息：**最后一条消息的内容**，导致用户无法快速判断会话的当前状态。

## 验收标准 (Acceptance Criteria)

- [ ] WHEN 扫描会话文件时，系统 SHALL 提取最后一条消息的内容（前 150 个字符）
- [ ] WHEN 扫描会话文件时，系统 SHALL 记录最后一条消息的角色（user/assistant）
- [ ] WHEN 显示会话列表时，系统 SHALL 在每个会话项中显示最后一条消息预览
- [ ] WHERE 最后一条消息是用户消息，系统 SHALL 显示用户图标
- [ ] WHERE 最后一条消息是助手消息，系统 SHALL 显示助手图标
- [ ] IF 最后一条消息超过 2 行，THEN 系统 SHALL 使用 line-clamp-2 截断显示

## 实施阶段

### Phase 1: 规划和准备
- [x] 分析需求和依赖
- [x] 设计技术方案（见下方关键决策）
- [x] 确定实施计划

### Phase 2: 后端实现
- [ ] 修改 `src-tauri/src/models.rs`：在 SessionInfo 结构体中添加 last_message 和 last_message_role 字段
- [ ] 修改 `src-tauri/src/scanner.rs`：在 parse_session_info 函数中提取最后一条消息
- [ ] 修改 `src-tauri/src/sqlite_cache.rs`：更新数据库 schema 和查询逻辑
- [ ] 测试后端数据提取逻辑

### Phase 3: 前端实现
- [ ] 修改 `src/types.ts`：在 SessionInfo 接口中添加 last_message 和 last_message_role 字段
- [ ] 修改 `src/components/SessionList.tsx`：添加最后一条消息的显示逻辑
- [ ] 添加用户/助手图标（User/Bot from lucide-react）
- [ ] 调整样式和布局

### Phase 4: 验证
- [ ] 测试不同长度的消息显示
- [ ] 测试用户消息和助手消息的图标显示
- [ ] 测试截断效果（line-clamp-2）
- [ ] 测试性能（大量会话）

### Phase 5: 交付
- [ ] 更新文档（SESSION_LIST_IMPROVEMENTS.md）
- [ ] 创建 PR
- [ ] 合并主分支

## 关键决策

| 决策 | 理由 |
|------|------|
| 提取最后 150 个字符 | 平衡信息量和性能，150 字符足够显示 2 行预览 |
| 记录消息角色 | 用于显示不同的图标（用户/助手），提供视觉区分 |
| 使用 line-clamp-2 | 限制高度，保持列表紧凑，避免过长消息占用过多空间 |
| 在后端提取数据 | 避免前端解析大量文本，提升性能 |
| 更新数据库 schema | 缓存最后一条消息，避免重复解析历史会话 |

## 技术方案

### 后端修改

#### 1. models.rs
```rust
pub struct SessionInfo {
    // ... 现有字段
    pub last_message: String,
    pub last_message_role: String,
}
```

#### 2. scanner.rs
```rust
pub fn parse_session_info(path: &Path) -> Result<SessionInfo, String> {
    // ... 现有代码
    let mut last_message = String::new();
    let mut last_message_role = String::new();
    
    for line in &lines[1..] {
        if let Ok(entry) = serde_json::from_str::<Value>(line) {
            if entry["type"] == "message" {
                let role = entry["message"]["role"].as_str().unwrap_or("");
                if role == "user" || role == "assistant" {
                    let text = extract_message_text(&entry);
                    if !text.is_empty() {
                        last_message = text.chars().take(150).collect();
                        last_message_role = role.to_string();
                    }
                }
            }
        }
    }
    
    Ok(SessionInfo {
        // ... 现有字段
        last_message,
        last_message_role,
    })
}
```

#### 3. sqlite_cache.rs
```sql
ALTER TABLE sessions ADD COLUMN last_message TEXT;
ALTER TABLE sessions ADD COLUMN last_message_role TEXT;
```

### 前端修改

#### 1. types.ts
```typescript
export interface SessionInfo {
    // ... 现有字段
    last_message?: string
    last_message_role?: string
}
```

#### 2. SessionList.tsx
```tsx
import { User, Bot } from 'lucide-react'

// 在消息预览区域添加：
{session.last_message && (
  <div className="flex items-start gap-2">
    {session.last_message_role === 'user' ? (
      <User className="h-3 w-3 text-blue-500 flex-shrink-0 mt-0.5" />
    ) : (
      <Bot className="h-3 w-3 text-green-500 flex-shrink-0 mt-0.5" />
    )}
    <p className="text-xs text-muted-foreground/80 line-clamp-2 leading-relaxed">
      {session.last_message}
    </p>
  </div>
)}
```

## 遇到的错误

| 日期 | 错误 | 解决方案 |
|------|------|---------|
| - | - | - |

## 相关资源

- [x] 相关文档: `SESSION_LIST_IMPROVEMENTS.md`
- [ ] 相关 Issue: 无
- [ ] 参考资料: 
  - Rust serde_json 文档
  - SQLite ALTER TABLE 语法
  - Tailwind CSS line-clamp 工具类

## Notes

### 第一阶段已完成
- ✅ UI 视觉改进已完成（卡片式设计、信息层次优化、交互改进）
- ✅ 使用 first_message 作为临时预览
- ✅ 添加目录智能截断
- ✅ 改进图标和颜色系统

### 待实现
- ⏳ 后端数据提取（last_message 字段）
- ⏳ 数据库 schema 更新
- ⏳ 前端显示逻辑

### 性能考虑
- 提取最后一条消息时，需要遍历整个 JSONL 文件
- 对于大文件（10000+ 行），可能需要优化（从文件末尾向前读取）
- 数据库缓存可以避免重复解析历史会话

---

## Status 更新日志

- **2026-01-31 15:18**: 创建 Issue，状态: todo